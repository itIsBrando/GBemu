<!doctype html>
<html manifest="game.manifest">
    <!-- <script src="https://apis.google.com/js/api.js"></script> -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="GBemu">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <!-- Disable zooming on iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta charset="UTF-8">
        <style>

            html, body {
                /* padding: 0px;
                height: 100%;
                margin: 0px;
                border: 0px; */
                width: 100%;
                background-color: rgb(54, 54, 54);
                position: fixed;
                /* overflow: hidden; */
                
                image-rendering: optimizeSpeed;
                image-rendering: -moz-crisp-edges;
                image-rendering: -webkit-optimize-contrast;
                image-rendering: optimize-contrast;
                image-rendering: pixelated;
                -ms-interpolation-mode: nearest-neighbor;
                
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                -webkit-touch-callout: none;
                
            }

            #touchControls {
                position: fixed;
                bottom: 0;
            }
            
            canvas {
                overflow: hidden;
            }

            /* Disable right click/highlighting */
            .no-selection {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                -webkit-touch-callout: none;
            }

            .dropdown {
                position: relative;
                display: inline-block;
            }
            
            .dropdown:hover .dropdown-background {
                display: block;
            }

            .dropdown-background {
                /* used for the <div> that hosts all submenu items */
                box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
                background-color: none;
                z-index: 2;
                display: none;
                width: 200px;
                left: 0;
                position: absolute;
            }

            .menubtn {
                background-color: aquamarine;
                display: block;   
                padding: 6px;
                margin-top: 1px;
                width: 100%;
                max-width: 250px;
                border: none;
            }

            .menubtn:hover {
                background-color: cyan;
            }

            /* Virtual Gamepad Buttons */
            .btn {
                margin: 10;
                background-color:blueviolet;
                padding: 10px;
                cursor: pointer;
                z-index: 10;
                border: none;
                display: inline-block;
                min-width: 40px;
                min-height: 0px;
                max-width: 200px;
                max-height: 250px;
                touch-action: manipulation;
            }

            .btn:active {
                background-color:indigo;
            }

            .center {
                width: 50%;
                border: 0px;
                margin-left: auto;
                margin-right: auto;
            }
        </style>
            <!-- Debugging features -->
            <div id="debugDIV" style="display:none">
                <buttontype="button" name="timerStop" id="timerStop">Stop</button>
                <!-- Enables stepping -->
                <button type="button" name="step" id="timerStep">Step</button>
            </div>
            
            <!-- Hidden items used for file reading dialogs -->
            <input type="file" name="inputfile" id="inputfile" accept=".gb, .gbc" style="display: none;" >
            <input type="file" name="inputSaveFile" id="inputSaveFile" accept=".sav" style="display: none;">
            
            <!-- file loading menu -->
            <div class="dropdown" style="float: left;">
                <button style="width: 200px;" type="button" id="fileMenuToggle" class="menubtn">File</button>
                
                <div id="loadMenu" class="dropdown-background">
                    <!-- ROM loading -->
                    <button type="button" class="menubtn" onmousedown="document.getElementById('inputfile').click();">Load ROM</button>
                    <!-- Save State loading -->
                    <button type="button" class="menubtn" onmousedown="document.getElementById('inputSaveFile').click()">Import Save File</button>
                </div>
            </div>
            
            <!-- options menu -->
            <div class="dropdown" style="float: left;">
                <button style="width: 200px;" type="button" id="optionsMenuToggle" class="menubtn">Options</button>
                
                <div id="optionsMenu" class="dropdown-background">
                    <button type="button" id="controlsToggle" class="menubtn">Toggle touch controls</button>
                    <button type="button" id="fullscreenToggle" class="menubtn">Fullscreen</button>
                </div>
            </div>
                
            <!-- Save Manager menu -->
            <div class="dropdown" style="float: left;">
                <button style="width: 200px;" type="button" id="saveMenuToggle" class="menubtn">Save Manager</button>
                
                <div id="saveMenu" class="dropdown-background">
                    <button type="button" id="exportSaveButton" class="menubtn">Export Save File</button>
                    <button type="button" id="gdButtonLogin" class="menubtn">Google Drive Sync</button>
                    <!-- <button type="button" id="idkeToggle" class="menubtn">Fullscreen</button> -->
                </div>
            </div>
                
            <!-- Screen -->
            <div id="viewport">
                <canvas style="width: 100%;" id="screen" width="160" height="144"></canvas>
            </div>

            <!-- Controller -->
            <div id="touchControls" oncontextmenu="event.preventDefault();" style="width: 100%; display: none; z-index: 10;" class="no-selection">
                <!-- UP & DOWN are hidden temporarily -->
                <button class="btn" style="position: absolute; left: 50px; bottom: 80px" type="button" name="UP" id="controllerUp">UP</button>
                <button class="btn" style="position: absolute; left: 50px; bottom: 0" type="button" name="DOWN" id="controllerDown">DOWN</button>
                <button class="btn" style="position: absolute; left: 0; bottom: 40px" type="button" name="LEFT" id="controllerLeft">LEFT</button>
                <button class="btn" style="position: absolute; left: 100px; bottom: 40px" type="button" name="RIGHT" id="controllerRight">RIGHT</button>
                <button class="btn" style="position: absolute; right: 10px; bottom: 80px" type="button" name="A" id="controllerA">A</button>
                <button class="btn" style="position: absolute; right: 100px; bottom: 40px;" type="button" name="B" id="controllerB">B</button>
                <button class="btn" style="position: absolute; left: 200px; bottom: 0;"type="button" name="START" id="controllerStart">START</button>
                <button class="btn" style="position: absolute; left: 150px; bottom: 0;"type="button" name="SELECT" id="controllerSelect">SELECT</button>

            </div>
            <!-- used to display errors -->
            <p id="errorP"></p>
            <!-- Used to save files -->
            <a id="saveA" style="display: none;" download></a>
        <body>
        <title>GBemu</title>
        <!-- Lovely library -->
        <script src="js/drive.js"></script>
        <script src="typescript/types.js"></script>
        <script src="typescript/controller.js"></script>
        <script src="typescript/renderer.js"></script>
        <script src="typescript/mbc/MBC1.js"></script>
        <script src="typescript/mbc/MBC2.js"></script>
        <script src="typescript/mbc/MBC3.js"></script>
        <script src="typescript/mbc/MBC5.js"></script>
        <script src="typescript/ppu.js"></script>
        <script src="typescript/instructionCB.js"></script>
        <script src="typescript/instruction.js"></script>
        <script src="typescript/timer.js"></script>
        <script src="typescript/register.js"></script>
        <script src="typescript/cpu.js"></script>
        <script src="typescript/initalize.js"></script>
        <script src="js/utility.js"></script>
        <script src="js/touch.js"></script>
        <script type="text/javascript">
            let inputForm = document.getElementById('inputfile');
            
            // for loading ROM
            inputForm.addEventListener('change', function() {
                let reader = new FileReader();
                reader.onload = function() {
                    console.log("ROM File: " + reader.result);
                }
                reader.readAsArrayBuffer(this.files[0]);

                reader.onloadend = function() {
                  startEmulation(reader.result)
                }
                
            });

            // Save file loading
            document.getElementById("inputSaveFile").addEventListener('change', function() {
                let reader = new FileReader();

                reader.readAsArrayBuffer(this.files[0]);

                let buffer = this.files[0];
                
                reader.onloadend = function() {
                    MBC1.useSaveData(reader.result);
                }
            });


            // for `file` menu tab
            // const loadMenu = document.getElementById('loadMenu');
            const fileMenuToggle = document.getElementById('fileMenuToggle');
            
            // for `options` menu tab
            const controlsToggle = document.getElementById('controlsToggle');
            // const optionsMenu = document.getElementById('optionsMenu');
            const optionsMenuToggle = document.getElementById('optionsMenuToggle');
            const fullscreenToggle = document.getElementById('fullscreenToggle');

            // const saveMenu = document.getElementById('saveMenu');
            const saveMenuToggle = document.getElementById('saveMenuToggle');
            const exportSaveButton = document.getElementById('exportSaveButton');


            controlsToggle.addEventListener('click', function() {
                document.getElementById("touchControls").style.display = "block";
            })

            // for 'fullscreen button'
            fullscreenToggle.addEventListener('click', function() {
                if(!requestFullscreen())
                {
                    fullscreenToggle.style.display = "none";
                    alert("This device does not support fullscreen");
                }
            });

            exportSaveButton.onclick = function() {
                // do saving
                const name = readROMName() + ".sav"
                const a = document.getElementById('saveA');
                if(!c.mbcHandler || c.mbcHandler.ramSize == 0)
                {
                    alert("This ROM does not have a RAM chip");
                    return;
                }
                // save file
                let blob = new Blob([c.mbcHandler.ram]);
                a.href = window.URL.createObjectURL(blob);
                a.download = readROMName() + ".sav"
                a.click();
            };

            // auto-hide if we are standalone
            if(window.navigator.standalone) {
                fullscreenToggle.style.display = "none";
            }
        </script>
    </body>
</head>