<!doctype html>
<html lang="en">

<head>
    <!-- iOS web app info -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="GBemu">
    <link rel="apple-touch-icon" href="icons/icon_108x108.png">
    <link rel="icon" href="icons/icon_108x108.png">
    <!-- Disable zooming on iOS -->
    <meta name="viewport"
        content="viewport-fit=cover, width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#aaaaaa">
    <!-- Desktop web app -->
    <link rel="manifest" href="manifest.webmanifest">

    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/themes.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        :root {
            --ui-title-color: #1b1b1b;
            --ui-title-text-color: white;
            --ui-main-text-color: ghostwhite;

            --ui-text-color: white;
            --ui-btn-color: #55555A;
        }

        .viewport {
            /* Why have i positioned this like a piece of dumbo? */
            /* don't use absolute poistioning D: */
            display: flex;
            justify-content: center;
            position: absolute;
            left: 2px;
            right: 2px;
            top: calc(30px + env(safe-area-inset-top));
            z-index: -1;
        }

        .viewport-no-title {
            top: 0px;
        }
        
        #viewport, #viewport * {
            transition: background 0.5s, border 0.5s, box-shadow 0.5s, top 0.4s; 
        }

        .screen-container {
            display: flex;
            background-color: var(--screen-border-color);
            width: clamp(160px, 100%, 100vmin);

            margin: 5px;
            border-radius: 10px;
            border-bottom-right-radius: 25px;
            box-shadow: 0px 8px 16px 10px var(--screen-shadow);
            border-style: solid;
            border-color: var(--screen-border-color);
            border-width: 25px 0px 20px 0px;
        }

        .screen-container-left {
            height: 100%;
            min-width: 25px;
            width: clamp(20px, 8vw, 60px);
            background-color: var(--screen-border-color);
        }

        .screen-container-right {
            display: inline-block;
            height: 100%;
            min-width: 10px;
            width: clamp(10px, 7vw, 50px);
            background-color: var(--screen-border-color);
        }

        .power-LED {
            background-color: var(--power-led-color);
            position: relative;
            border-radius: 100vmax;
            transform: translateX(-50%);
            left: 50%;
            top: 20%;
            width: 10px;
            aspect-ratio: 1 / 1;
            box-shadow: 0px 0px 6px 2px var(--power-led-color);
        }

        .viewport-full * {
            border: none !important;
            margin: 0px;
        }

        .viewport-full #screen {
            border-radius: 0px;
            border-bottom-right-radius: 12px;
            border-bottom-left-radius: 12px;
        }

        .viewport-full .screen-container-left, .viewport-full .screen-container-right {
            display: none;
        }

        #screen {
            border-radius: 5px 10px 25px 5px;
            width: 100%;
            height: 100%;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown:hover .dropdown-background {
            display: block;
        }

        .dropdown-background {
            /* used for the <div> that hosts all submenu items */
            box-shadow: 0px 8px 16px 6px rgba(0, 0, 0, 0.2);
            position: absolute;
            display: none;
            left: 0;
            z-index: 0;
        }

        .popup, .popup-no-border {
            display: none;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            border: 5px solid var(--ui-title-color);
            color: var(--ui-main-text-color);
            z-index: 9;
            border-radius: 5px;
            width: fit-content;
            min-width: 350px;
            max-height: 80vh;
        }

        .menu-header, .menu-header-no-ext {
            font-size: 1.25rem;
            font-family: monospace;
            background-color: var(--ui-title-color);
            color: var(--ui-title-text-color);
            height: fit-content;
            min-height: 30px;
        }

        .menu-header-no-ext {
            background-color: transparent;
            padding: 5px 0px 5px 5px;
        }

        .menu-header > a {
            margin: 5px;
            display: inline-block;
        }

        .popup-no-border {
            border: 5px solid #333;
        }


        .prompt-menu-fieldset {
            width: calc(100% - 12px);
            padding: 7px 5px 10px 5px;
            margin: 0px;
            border: none;
        }

        .prompt-menu-legend {
            background-color: inherit;
        }

        .prompt-menu-radio {
            display: none;
        }

        .prompt-menu-radio:checked + label {
            background-color: #999;
        }

        .prompt-menu-choice {
            display: block;
            background-color: #555;
            border-radius: 5px;
            margin-bottom: 2px;
            cursor: pointer;
            text-align: center;
        }
        
        .prompt-menu-choice:hover {
           background-color: #777;
        }

        .div-separator {
            width: 100%;
            border-top: 2px solid #ddd;
            margin-top: 8px;
            padding-top: 3px;
            padding-left: 0.5rem;
        }

        .div-separator:empty {
            padding-left: 0px;
        }

        .settings-grid {
            display: flex;
            flex-direction: column;
            background-color: #444444;
            margin: 10px;
            border-radius: 5px;
            gap: 5px;
        }

        .settings-grid label {
            padding-left: 10px;
        }

        .settings-title {
            padding: 5px 0px 0px 5px;
            margin-bottom: 15px;
            color: #bbeeff;
        }

        .settings-checkbox {
            appearance: none;
            cursor: pointer;
            background-color: transparent;
            border-radius: 6px;
            max-width: 21px;
            max-height: 21px;
            aspect-ratio: 1 / 1;
            align-self: center;
            padding: 0px 10px;
            margin: 3px 6px;
            transition: 0.15s;
            opacity: 0.5;
            border: 2px solid #eee;
            float: right;
        }

        .settings-checkbox:hover {
            filter: brightness(0.8);
        }

        .settings-checkbox:checked {
            background-color: #aaddee;
            border-color: #aaddee;
            opacity: 1;
        }

        .info-content {
            font-size: 1rem;
            display: none;
            position: absolute;
            background-color: #333;
            padding: 0.5rem 1rem;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.7);
            color: aliceblue;
            text-align: left;
            top: 100%;
            right: 0px;
            width: clamp(150px, 60vw, 650px);
        }

        .info-div {
            position: relative;
            float: right;
        }

        .info-div:hover > .info-content  {
            display: block;
        }

        .info-div:hover > .info-btn, .info-btn:hover {
            background-color: #333;
            color: aliceblue;
        }

        #keyBindingDiv {
            width: fit-content;
            height: fit-content;
            overflow-y: hidden;
        }

        #saveButtonDiv {
            height: 100%;
            width: 100%;
            max-height: 100vh;
            overflow-y: auto;
            background-color: inherit;
        }
        
        .bind-div-child {
            max-height: calc(80vh - 30px);
            overflow-y: auto;
            width: 100%;
        }

        .shadow {
            box-shadow: 0 0 0 100vmax rgb(0, 0, 0, 0.5);
            transform-style: preserve-3d;
        }

        .shadow::before {
            content: '';
            position: absolute;
            left: -100vw;
            top: -100vh;
            background-color: black;
            width: 500vw;
            height: 500vh;
            opacity: 0.3;
            transform: translateZ(-10px);
            z-index: -1;
        }

        @media (max-width: 500px),
        (max-height: 500px) and (orientation: landscape) {
            /* This makes 'popup' menus fullscreen */
            /* @todo why do some popup menus not get full screen? */
            #popup, #keyBindingDiv, #SettingsDiv {
                border: none;
                position: absolute;
                top: 0px;
                left: 0px;
                transform: translate(0, 0);
                padding-right: env(safe-area-inset-right);
                padding-left: env(safe-area-inset-left);
                padding-bottom: 2vh;
                width: 100%;
                height: 100%;
                max-height: unset;
                overflow: hidden;
                border-radius: 0px;
            }
            
            .bind-div-child {
                 max-height: 100%;
            }

            .settings-grid {
                max-height: calc(100% - 30px);
                overflow: hidden auto;
            }
        }

        * {
            box-sizing: border-box;
        }
    </style>
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/debug.css">
    <link rel="stylesheet" href="css/touch.css">
    <title>GBemu</title>
    <!-- test button -->
    <svg id="sampleSVG" style="display: none;">
        <g>
            <rect class="gamepad-button-bottom" x="5" y="5" rx="5" ry="5" width="45" height="45" />
            <rect class="gamepad-button-top" x="0" y="0" rx="5" ry="5" width="45" height="45" />
        </g>
    </svg>
    <svg id="smallSampleSVG" style="display: none;">
        <g>
            <rect class="gamepad-button-bottom" x="5" y="5" rx="5" ry="5" width="40" height="20" />
            <rect class="gamepad-button-top" x="0" y="0" rx="5" ry="5" width="40" height="20" />
        </g>
    </svg>

    <!-- Hidden items used for file reading dialogs -->
    <input type="file" name="inputfile" id="inputfile" accept=".gb, .gbc" style="display: none;">
    <input type="file" name="inputSaveFile" id="inputSaveFile" accept=".sav" style="display: none;">

    <!-- file loading menu -->
    <div class="dropdown" style="float: left;" id="dropdown1">
        <button type="button" id="fileMenuToggle" class="title-btn"><b>File</b></button>

        <div id="loadMenu" style="width: 33vw;" class="dropdown-background">
            <!-- ROM loading -->
            <button type="button" class="dropdown-btn"
                id="LoadRom" title="Load ROM file from local files.">Load
                ROM <a class="shortcut-text">(Ctrl+O)</a></button>
            <!-- Savefile uploading -->
            <button type="button" title="Upload .sav files from your local device"
                class="dropdown-btn" onclick="document.getElementById('inputSaveFile').click()">Import Save File</button>
            <!-- Savefile downloading -->
            <button type="button" title="Download a .sav file to you local device"
                id="exportSaveButton" class="dropdown-btn">Export Save File</button>
            <!-- ROM Info -->
            <button type="button" class="dropdown-btn" onclick="showROMInfo()">ROM Info</button>
            <!-- Reset Game -->
            <button type="button" class="dropdown-btn" onclick="restartEmulation()">reset game <a class="shortcut-text">(Ctrl+R)</a></button>
        </div>
    </div>

    <!-- options menu -->
    <div class="dropdown" style="float: left;" id="dropdown2">
        <button type="button" id="optionsMenuToggle" class="title-btn"
            style="width: 34vw;"><b>Options</b></button>
        <div id="optionsMenu" style="width: 34vw;" class="dropdown-background">
            <button type="button" class="dropdown-btn" onclick="Themes.next();">Themes</button>
            <button type="button" id="enterDebugger" class="dropdown-btn"
            onclick="Debug.start();">Debugger <a class="shortcut-text">(Ctrl+D)</a></button>
            <button type="button" class="dropdown-btn"
            onclick="Cheats.start();">Cheats</button>
            <!-- <button type="button" class="dropdown-btn"
            onclick="Link.start();">Link Cable</button> -->
            <button type="button" title="open settings" class="dropdown-btn" onclick="Settings.show();">Settings</button>
        </div>
    </div>

    <!-- Save Manager menu -->
    <div class="dropdown" style="float: left;" id="dropdown3">
        <button type="button" id="saveMenuToggle" class="title-btn"><b>Saves</b></button>
        <div id="saveMenu" style="width: 33vw;" class="dropdown-background">
            <button type="button" id="localSaveButton" class="dropdown-btn">Internal Save</button>
            <button type="button" id="localLoadButton" class="dropdown-btn">Internal Load</button>
            <button type="button" id="importTextButton" class="dropdown-btn"
                onclick="SaveManager.importJSON();">Import JSON Text</button>
        </div>
    </div>

    <!-- Screen -->
    <div id="viewport" class="viewport">
        <div id="screen-container" class="screen-container">
            <div class="screen-container-left">
                <div class="power-LED"></div>
            </div>
            <canvas id="screen" width="160" height="144"> </canvas>
            <div class="screen-container-right"></div>
        </div>
        <!-- Menu button to show the top menu -->
        <div class="show-menu-btn" onclick="Menu.title.toggle();"></div>
    </div>
    
    <!-- Link Cable menu -->
    <div id="LinkDiv" class="popup shadow">
        <div class="menu-header-no-ext">
            <b>Link Cable</b>
            <button type="button" class="x-btn" onclick="Link.hide();">&times;</button>
        </div>
        Get started by creating a session and a code,
         then join the session from another device using the same code.
        <div style="font-size: 0.85rem; background-color: orangered;">
            Using multiplayer is unstable and poorly tested. Use at your own risk.
        </div>
        <button type="button" onclick="Link.startSess();" class="menubtn settings-btn">Create session</button>
        <button type="button" onclick="Link.joinSess();" class="menubtn settings-btn">Join session</button>
    </div>

    <!-- Settings menu -->
    <div id="SettingsDiv" class="popup shadow">
        <div class="menu-header">
            <a style="padding-left: 5px;">Settings</a>
            <button type="button" class="x-btn" onclick="Settings.hide();">&times;</button>
        </div>
        <div class="settings-grid" style="grid-template-rows: repeat(10, 40px);">
            <b class="settings-title">Emulation</b>
            <!-- Emulation Mode -->
            <label for="toggleDMGMode">Emulation Mode:
                <button type="button" name="emuMode" id="toggleDMGMode" title="Changes emulation mode."
                    class="menubtn settings-btn" onclick="forceEmulationMode(!c.forceDMG);"></button>
                </label>
            <!-- DMG Palette -->
            <label for="dmgPal">DMG Palette Colors:
                <button type="button" id="dmgPal" name="dmgPal" class="menubtn settings-btn"
                        onclick="Palette.show();">edit</button>
            </label>
            <label for="sndButton">Enable Sound:
                <input type="checkbox" class="settings-checkbox" id="sndButton" name="sndEnable" title="enable/disable sound" onclick="APU.toggle(this);">
            </label>
            <b class="settings-title">Controls</b>
            <!-- Toggle touch controls -->
            <label for="controlsToggle">Touch Controls:
                <input type="checkbox" name="Ctrls" id="controlsToggle" class="settings-checkbox">
            </label>
            <!-- Gamepad controls -->
            <label>Gamepad connected:
                <input type="checkbox" class="settings-checkbox" id="gamepadConnected" disabled>
            </label>
            <!-- change keyboard controls -->
            <label for="changeKeybinding">Keyboard Controls:
                <button type="button" id="changeKeybinding" name="keybind" class="menubtn settings-btn"
                    onclick="KeyBinding.show();">edit</button>
            </label>
            <!-- Other -->
            <b class="settings-title">Other</b>
            <!-- Power consumption -->
            <label for="pwrComp">Power consumption:
                <input type="checkbox" name="pwrComp" title="Show CPU power usage" class="settings-checkbox" onclick="c.powerConsumptionShown = !c.powerConsumptionShown; powerConsumption.style.display = powerConsumption.style.display == 'none' ? 'block' : 'none';">
            </label>
            <label for="BorderButton">Screen border:
                <input type="checkbox" name="border" id="BorderButton" class="settings-checkbox" title="Shows/hides the border around the screen" checked>
            </label>
            <label for="AutoLoadButton">Load save on startup:
                <input type="checkbox" name="autoload" id="AutoLoadButton" class="settings-checkbox" title="Loads a save when a game is loaded.">
            </label>
            <label for="PrevImgButton">Save Preview Image:
                <input type="checkbox" name="prevImg" id="PrevImgButton" onclick="SaveStorage.togglePreview();" class="settings-checkbox" title="Saves a preview image of the game when using 'internal saves'.">
            </label>
            <a id="version" style="grid-column: 1 / 3; text-align: right; padding: 3px; font-size: 0.65rem;"></a>
        </div>
    </div>

    <!-- Cheats Menu -->
    <div id="CheatsDiv" class="popup-no-border shadow">
        <div class="menu-header-no-ext">
            Cheats
            <button type="button" class="x-btn" onclick="Cheats.hide();">&times;</button>
            <button onclick="Cheats.add();" class="icon-btn" style="float: right;" type="button">+</button>
        </div>
            <fieldset id="CheatsList" class="debug-box"
                style="height: clamp(100px, 150px, 250px); overflow-y: auto; border:none; font-family: monospace;">
            </fieldset>
            <button style="width: 100%; visibility: hidden;" type="button" class="menubtn" onclick="Cheats.rm();" id="CheatsRm">remove
                code</button>
    </div>

    <!-- Debug menu -->
    <div id="DebugDiv" class="popup shadow debug-main-div">
    <div style="display: grid; grid-template-columns: repeat(6, 1fr) 30px; overflow-x: auto; border-bottom: 1px solid #666;">
            <button type="button" class="menubtn debug-title-btn" onclick="Debug.showTiles();">Tiles</button>
            <button type="button" class="menubtn debug-title-btn" onclick="Debug.showSprites();">OAM</button>
            <button type="button" class="menubtn debug-title-btn" onclick="Debug.showMap();">Map</button>
            <button type="button" class="menubtn debug-title-btn"
                onclick="Debug.showDisasm();">Disassembly</button>
            <button type="button" class="menubtn debug-title-btn" onclick="Debug.showMemory();">Memory</button>
            <button type="button" class="menubtn debug-title-btn" onclick="Debug.showPalette();">Palette</button>
            <button type="button" class="menubtn debug-title-btn" onclick="Debug.quit();">&times;</button>
        </div>
        <div id="PalDiv" class="debug-pal-tab">
            <div id="PalBG" class="debug-pal-prev debug-box"></div>
            <div id="PalOBJ" class="debug-pal-prev debug-box"></div>
        </div>
        <div class="debug-map-div" id="MapDiv">
            <div>
                <div id="MapInfo" class="debug-box">
                    <fieldset style="border: none;">
                        <input type="radio" class="debug-radio" name="displayMode" value="map" checked />
                        <label for="map">Map</label><br>
                        <input type="radio" class="debug-radio" name="displayMode" value="window" />
                        <label for="window">Window</label>
                    </fieldset>
                    <pre class="debug-text" style="padding-left: 10px;"></pre>
                </div>
                <div id="TilePrevDiv" class="debug-box">
                    <div style="display: flex; justify-content: center;">
                        <canvas id="TilePreview" width="8" height="8"></canvas>
                    </div>
                    <div class="div-separator"></div>
                    <div style="display:grid; grid-template-columns: 1fr min-content;">
                        <a id="TileInfo" class="debug-text"></a>
                        <div>
                            <label for="mapZoomInput" style="text-align: center;">zoom</label>
                            <input id="mapZoomInput" type="range" min="1" max="8" value="2">
                        </div>
                    </div>
                </div>
            </div>
            <div id="MapCanvasDiv" class="debug-box">
                <canvas id="MapCanvas" width="256" height="256"></canvas>
            </div>
        </div>
        <div id="OamDiv" style="font-family: monospace;">
            <div class="debug-box" style="min-width: 256px;">
                <h3 style="text-align:center;">Sprite 0</h3>
                <div id="DebugSprites"></div>
            </div>
            <p class="debug-box" style="padding: 10px;"></p>
        </div>
        <!-- Memory viewer -->
        <div id="MemoryDiv">
            <div style="justify-content: center;">
                <!-- control buttons -->
                <button type="button" onclick="Memory.dumpType(this.innerText);" class="disasm-btn">rom0</button>
                <button type="button" onclick="Memory.dumpType(this.innerText);" class="disasm-btn">romx</button>
                <button type="button" onclick="Memory.dumpType(this.innerText);" class="disasm-btn">vram</button>
                <button type="button" onclick="Memory.dumpType(this.innerText);" class="disasm-btn">cram</button>
                <button type="button" onclick="Memory.dumpType(this.innerText);" class="disasm-btn">wram</button>
                <button type="button" onclick="Memory.dumpType(this.innerText);" class="disasm-btn">hram</button>
                <br>
            </div>
            <div style="overflow: auto auto; padding-left: 10px;">
                <b><pre class="debug-text">   address       00   01   02   03   04   05   06   07   08   09   0A   0B   0C   0D   0E   0F</pre></b>
                <pre id="MemoryContent" class="debug-text debug-memory-text"></pre>
            </div>
        </div>
        <div id="DisassemblyDiv" class="disasm-main-div">
            <!-- instructions div -->
            <div class="debug-box" style="overflow: auto;">
                <input type="file" name="symFile" id="symFile" accept="*.sym" style="display:none;">
                <pre style="margin: 0px;">   addr   opcode     mnemonic</pre>
                <pre id="DisasmContent" class="debug-text"></pre>
            </div>
            <!-- Register DIV -->
            <div style="overflow: hidden auto; height: calc(100% - 30px);" class="debug-box">
                <canvas width="160" height="144" style="width: 100%;" id="DisassemblyCanvas"></canvas>
                <pre id="DisassemblyRegisters" class="debug-text" style="padding: 5px; overflow-y: auto;"></pre>
            </div>
            <div class="disasm-buttons">
                <button type="button" class="disasm-btn" onclick="Disassembler.step();">step</button>
                <button type="button" class="disasm-btn" onclick="Disassembler.stepLine();">run to next
                    line</button>
                <!-- <button type="button" class="disasm-btn" onclick="Disassembler.runToBreak();">run until break</button> -->
                <button type="button" class="disasm-btn" onclick="Disassembler.stepOut();">step out</button>
                <button type="button" class="disasm-btn" onclick="Disassembler.goto();">goto</button>
                <button type="button" class="disasm-btn" onclick="Disassembler.search();">search</button>
                <button type="button" class="disasm-btn" onclick="Disassembler.resetGame();">reset</button>
                <!-- <button type="button" class="disasm-btn" onclick="Debug.showBreak();">breakpoints</button> -->
                    <!-- <button style="width:100%;" type="button" class="menubtn" title="Add define list from RGBDS sym file."
                    onclick="document.getElementById('symFile').click();">Upload sym file</button> -->
            </div>
        </div>
        <!-- A new menu for managing breakpoints -->
        <div id="DisassemblyBreakpoints" class="popup-no-border shadow">
            <div class="menu-header-no-ext">
                <b>Breakpoints</b>
                <button onclick="Debug.hideBreak();" class="x-btn" type="button">&times;</button>
            </div>
            <fieldset id="DisBreakpointList"
                style="height: clamp(100px, 150px, 250px); overflow-y: auto; border:none; font-family: monospace;">
            </fieldset>
            <button onclick="Debug.addBreak();" class="menubtn" style="width:100%;" type="button">Add
                Breakpoint</button>
            <button style="width: 100%;" type="button" class="menubtn" onclick="Debug.rmBreak();">remove
                breakpoint</button>
        </div>
    </div>

    <!-- Cool lookin menu for entering text. See `PromptMenu`-->
    <div id="PromptMenu" class="popup-no-border shadow" style="z-index:10;">
        <div class="menu-header-no-ext">
            <a id="PromptTitle">Title</a>
            <button type="button" class="x-btn" onclick="PromptMenu.hide();">&times;</button>
            <div class="info-div" style="display: none;">
                <button type="button" class="info-btn"></button>
                <div id="PromptInfo" class="info-content"></div>
            </div>
        </div>
        <div id="PromptDiv"></div>
        <input type="text" name="PromptText" id="PromptText" />
        <button type="button" id="PromptSubmit" class="prompt-button"
            onclick="PromptMenu.submit();">OK</button>
    </div>

    <!-- Virtual Controller -->
    <div id="touchControls" oncontextmenu="event.preventDefault();" style="width: 100%; display: none; z-index: 8;">
        <div id="dpadButtons">
            <svg class="gamepad-button" width="50" height="50" name="UP" id="controllerUp"></svg>
            <svg class="gamepad-button" width="50" height="50" name="DOWN" id="controllerDown"></svg>
            <svg class="gamepad-button" width="50" height="50" name="LEFT" id="controllerLeft"></svg>
            <svg class="gamepad-button" width="50" height="50" name="RIGHT" id="controllerRight"></svg>
        </div>
        <svg class="gamepad-button" width="50" height="50" name="A" id="controllerA"></svg>
        <svg class="gamepad-button" width="50" height="50" name="B" id="controllerB"></svg>

        <svg class="gamepad-button" width="50" height="25" name="START" id="controllerStart"></svg>
        <svg class="gamepad-button" width="50" height="25" name="SELECT" id="controllerSelect"></svg>
        <svg class="gamepad-button" width="50" height="50" id="controllerFastForward"></svg>
    </div>


    <!-- pop up menu for changing keyboard controls -->
    <div class="popup" id="keyBindingDiv"> 
        <div class="menu-header">
            <a>Keybindings</a>
            <button class="x-btn" onclick="KeyBinding.hide();">&times;</button>
            <button class="icon-btn" style="font-family: Lucida Sans Unicode; float: right;" title="reset" onclick="KeyBinding.setDefault();">&#x21bb;</button>
        </div>
        <div class="bind-div-child">
        <div class="settings-grid" style="grid-template-rows: repeat(14, 40px);">
            <b class="settings-title">Gameboy buttons</b>
            <label>A Button:
                <button type="button" onclick="KeyBinding.assign('A', this);" class="key-binding settings-btn menubtn"></button>
            </label>
            <label>B Button:
                <button type="button" onclick="KeyBinding.assign('B', this);" class="key-binding settings-btn menubtn"></button>
            </label>
            <label>SELECT Button:
                <button type="button" onclick="KeyBinding.assign('SELECT', this);" class="key-binding settings-btn menubtn"></button>
            </label>
            <label>START Button:
                <button type="button" onclick="KeyBinding.assign('START', this);" class="key-binding settings-btn menubtn"></button>
            </label>
            <label>UP Button:
                <button type="button" onclick="KeyBinding.assign('UP', this);" class="key-binding settings-btn menubtn"></button>
            </label>
            <label>DOWN Button:
                <button type="button" onclick="KeyBinding.assign('DOWN', this);" class="key-binding settings-btn menubtn"></button>
            </label>
            <label>LEFT Button:
                <button type="button" onclick="KeyBinding.assign('LEFT', this);" class="key-binding settings-btn menubtn"></button>
            </label>
            <label>RIGHT Button:
                <button type="button" onclick="KeyBinding.assign('RIGHT', this);" class="key-binding settings-btn menubtn"></button>
            </label>
            <b class="settings-title">Emulation buttons</b>
            <label>Fast Foward:
                <button type="button" onclick="KeyBinding.assign('FAST', this);" class="key-binding settings-btn menubtn"></button>
            </label>
            <label>Fullscreen:
                <button type="button" onclick="KeyBinding.assign('FULLSCREEN', this);" class="key-binding settings-btn menubtn"></button>
            </label>
        </div></div>
    </div>

    <!-- Pop up menu for saving/loading states -->
    <div class="popup shadow save-menu" id="popup" style="overflow: hidden;">
        <div class="menu-header" id="popup-title">
            <a>Save Files</a>
            <button type="button" class="x-btn" onclick="SaveManager.hide();">&times;</button>
            <div class="info-div">
                <button type="button" class="info-btn"></button>
                <div class="info-content">
                    Saves are stored in the browser's <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage">localStorage</a> object.
                    They will persist there unless they are removed by clearing <b>browser data</b>.
                    <div class="div-separator" style="font-size: 0.75em;">
                        Makes sure you download important saves to your computer using <b>File -> Export Save File</b>
                    </div>
                </div>
            </div>
            <button id="saveEditButton" type="button" class="menubtn ui-title-btn" style="background-color: transparent">edit</button>
            <button id="plusButton" type="button" class="menubtn ui-title-btn" onclick="SaveManager.addSave();">+</button>
        </div>
        <!-- Holds all of the save's button -->
        <div id="saveButtonDiv" ></div>
    </div>

    <!-- Change palette colors -->
    <div class="popup-no-border shadow" id="paletteSetDiv">
        <div class="menu-header-no-ext" style="border: 1px solid #333; text-align: center;">
            <!-- header -->
            <button type="button" class="x-btn" onclick="Palette.hide()">&times;</button>
            <!-- arrows -->
            <button type="button" class="icon-btn" style="float: left;"
                onclick="Palette.onPaletteArrow(-1)">&larr;</button>
            <button type="button" class="icon-btn" style="float: right;"
                onclick="Palette.onPaletteArrow(1)">&rarr;</button>
            <!-- <button type="button" class="icon-btn" style="float: right;" onclick="Palette.apply();">&#x2713;</button> -->
            <a id="paletteTitle"></a>
        </div>
        <!-- color inputs -->
        <div class="palette-menu">
            <div id="colorPreview0" class="color-preview"></div>
            <div id="colorPreview1" class="color-preview"></div>
            <div id="colorPreview2" class="color-preview"></div>
            <div id="colorPreview3" class="color-preview"></div>
        </div>
        <button onclick="Palette.apply();" type="button" id="colorSelected" class="menubtn" style="width:100%;">select</button>
    </div>

    <!-- Pretty-ish messaging system. -->
    <div id="messageID" class="popup-no-border shadow" style="border: 1px solid #333;">
        <!-- header -->
        <div id="messageHeader" class="menu-header-no-ext"></div>
        <!-- body -->
        <p id="messageContent" style="color: #ccc; padding-left: 0.5em;">Message Content</p>
        <!-- confirm -->
        <button class="prompt-button" style="margin-left: 5px;" id="messageConfirm">OK</button>
        <button class="prompt-button" id="messageCancel">Cancel</button>

    </div>
    
    <!-- Pretty-ish alert system. -->
    <div id="AlertDiv" class="alert-div"></div>

    <a id="powerConsumption" style="display: none; color: lightblue;">power consumption: 0%</a>

    <!-- Used to save files but is never shown-->
    <a id="saveA" style="display: none;" download></a>

<body>
    <script src="util/promptMenu.js"></script>
    <script src="util/menu.js"></script>
    <script src="util/settings.js"></script>
    <script src="util/saveManager.js"></script>
    <script src="util/themes.js"></script>
    <script src="util/utility.js"></script>
    <script src="util/keyboard.js"></script>
    <script src="util/controller.js"></script>
    <script src="util/debug.js"></script>
    <script src="util/debug/Opcode.js"></script>
    <script src="util/debug/Disassembler.js"></script>
    <script src="util/debug/Map.js"></script>
    <script src="util/debug/Oam.js"></script>
    <script src="util/debug/Tiles.js"></script>
    <script src="util/debug/Memory.js"></script>
    <script src="util/link.js"></script>
    <script src="javascript/types.js"></script>
    <script src="javascript/renderer.js"></script>
    <script src="javascript/mbc/MBC1.js"></script>
    <script src="javascript/mbc/MBC2.js"></script>
    <script src="javascript/mbc/MBC3.js"></script>
    <script src="javascript/mbc/MBC5.js"></script>
    <script src="javascript/audio/c1.js"></script>
    <script src="javascript/audio/c2.js"></script>
    <script src="javascript/audio/c3.js"></script>
    <script src="javascript/audio/c4.js"></script>
    <script src="javascript/audio/apu.js"></script>
    <script src="javascript/serial.js"></script>
    <script src="javascript/ppu.js"></script>
    <script src="javascript/instructionCB.js"></script>
    <script src="javascript/instruction.js"></script>
    <script src="javascript/timer.js"></script>
    <script src="util/cheats.js"></script>
    <script src="javascript/cpu.js"></script>
    <script src="javascript/initalize.js"></script>
    <script src="util/palette.js"></script>
    <script src="util/touch.js"></script>
    <script type="text/javascript">
        
        let inputForm = document.getElementById('inputfile');

        // for loading ROM
        inputForm.addEventListener('change', function () {
            let reader = new FileReader();

            reader.readAsArrayBuffer(this.files[0]);
            
            reader.onloadend = function () {
                startEmulation(reader.result);
            }
        });

        document.getElementById('LoadRom').addEventListener('click', function() {
            inputForm.click();
        })

        // Save file loading
        document.getElementById("inputSaveFile").addEventListener('change', function () {
            let reader = new FileReader();

            if (!this.files[0])
                return;

            reader.readAsArrayBuffer(this.files[0]);

            let buffer = this.files[0];

            reader.onloadend = function () {
                MBC1.useSaveData(reader.result);
            }
        });


        // remove old service workers
        const removeServiceWorkers = function() {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                if (!registrations.length) {
                    console.log('[Service Worker] No workers found.');
                    return
                }
                
                for(let registration of registrations) {
                    registration.unregister().then(function (bool) {
                        console.log(
                            bool ? '[Service Worker] Successfully removed worker'
                            : '[Service Worker] Failed to remove worker');
                    })
                }
            }).catch(err => {
                console.log('[Service Worker] Not in secure context');
            })
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(null, (err) => {
                    console.log('[Service Worker] Could not install service worker.', err);
                    Settings.set_core('sw_status', 'n/a');
            });
        }

        const _set_var = function(x) {
            Settings.set_temp("change_status_bar", x.matches);

            if(SaveManager.showing() || Settings.showing())
                Themes.setSettingsBar();
        }

        const x = window.matchMedia(
            "(max-width: 500px), (max-height: 500px) and (orientation: landscape)"
        );

        _set_var(x);
        x.addListener(_set_var);

        SaveStorage.init();
        Themes.init();
    </script>
</body>
</head>

</html>
